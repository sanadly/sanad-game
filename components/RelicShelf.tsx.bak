'use client';

import { useState } from 'react';
import { motion } from 'framer-motion';
import { useGameStore } from '@/store/gameStore';
import Icon from './Icon';

export default function RelicShelf() {
  const relics = useGameStore((state) => state.relics);
  const [isShaking, setIsShaking] = useState(false);

  const getRelicIcon = (id: string): 'blauePass' | 'libertyAutomaton' | 'scholarsDiploma' | 'locked' => {
    if (id === 'blaue-pass') return 'blauePass';
    if (id === 'liberty-automaton') return 'libertyAutomaton';
    if (id === 'scholars-diploma') return 'scholarsDiploma';
    return 'locked';
  };

  const playVictoryFanfare = () => {
    const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
    
    // Victory fanfare melody
    const notes = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, C (C major chord)
    
    notes.forEach((freq, i) => {
      setTimeout(() => {
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = freq;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.3);
      }, i * 100);
    });
  };

  const handleRelicClick = (relic: any) => {
    if (relic.unlocked) {
      setIsShaking(true);
      playVictoryFanfare();
      setTimeout(() => setIsShaking(false), 500);
    }
  };

  return (
    <div className={`mt-8 ${isShaking ? 'screen-shake' : ''}`}>
      <div className="pixel-card max-w-4xl mx-auto" aria-label="RELIC COLLECTION">
        <h3 className="text-sm text-center mb-6 text-gray-300 text-pixel">RELIC COLLECTION</h3>
        <div className="flex gap-6 justify-center flex-wrap">
          {relics.map((relic) => (
            <motion.div
              key={relic.id}
              className="relative pixel-card w-40 h-40 flex flex-col items-center justify-center cursor-pointer"
              initial={{ opacity: 0.3 }}
              animate={{ opacity: relic.unlocked ? 1 : 0.3 }}
              whileHover={relic.unlocked ? { scale: 1.05, y: -5 } : {}}
              onClick={() => handleRelicClick(relic)}
              onKeyDown={(e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  handleRelicClick(relic);
                }
              }}
              tabIndex={relic.unlocked ? 0 : -1}
              role="button"
              aria-label={relic.unlocked ? `View ${relic.name}` : 'Locked relic'}
            >
              <div className="mb-3">
                <Icon 
                  name={relic.unlocked ? getRelicIcon(relic.id) : 'locked'} 
                  size={64} 
                  className="pixel-art"
                />
              </div>
              <div className="text-xs text-center text-gray-300 mb-2 font-bold text-pixel">
                {relic.unlocked ? relic.name : 'Locked'}
              </div>
              {relic.unlocked && (
                <div className="text-xs text-center text-pixel-accent px-2 leading-relaxed">
                  {relic.description}
                </div>
              )}
              {relic.unlocked && (
                <motion.div
                  className="absolute inset-0 pointer-events-none"
                  initial={{ scale: 0 }}
                  animate={{ scale: [1, 1.2, 1] }}
                  transition={{ duration: 2, repeat: Infinity }}
                  style={{
                    background: 'radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%)',
                  }}
                />
              )}
              {relic.id === 'blaue-pass' && relic.unlocked && (
                <div className="absolute -top-2 -right-2 text-xs text-pixel-gold pixel-border px-2 py-1 bg-pixel-dark">
                  190+
                </div>
              )}
            </motion.div>
          ))}
        </div>
      </div>
    </div>
  );
}
